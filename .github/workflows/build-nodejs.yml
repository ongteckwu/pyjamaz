name: Build Node.js Packages

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.1.0, etc.)
  workflow_dispatch:  # Allow manual triggering
    inputs:
      skip_publish:
        description: 'Skip publishing to npm'
        required: false
        default: 'false'

jobs:
  build_packages:
    name: Build package for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # macOS builds
          - os: macos-13
            arch: x64
            platform: darwin
          - os: macos-14
            arch: arm64
            platform: darwin
          # Linux builds
          - ubuntu-22.04
            arch: x64
            platform: linux

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.15.1

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libavif

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libavif-dev

      - name: Build Zig library
        run: |
          zig build

      - name: Install Node.js dependencies
        working-directory: bindings/nodejs
        run: |
          npm ci

      - name: Build TypeScript
        working-directory: bindings/nodejs
        run: |
          npm run build

      - name: Bundle native libraries
        working-directory: bindings/nodejs
        run: |
          mkdir -p native

          # Copy libpyjamaz
          if [ "$RUNNER_OS" == "macOS" ]; then
            cp ../../zig-out/lib/libpyjamaz.dylib native/
            cp /opt/homebrew/opt/libavif/lib/libavif.16.dylib native/
          elif [ "$RUNNER_OS" == "Linux" ]; then
            cp ../../zig-out/lib/libpyjamaz.so native/
            cp /usr/lib/x86_64-linux-gnu/libavif.so.16 native/ || cp /usr/lib/libavif.so.16 native/
          fi

      - name: Run tests
        working-directory: bindings/nodejs
        run: |
          npm test
        env:
          # Tests should use bundled library
          PYJAMAZ_LIB_PATH: ""

      - name: Create package tarball
        working-directory: bindings/nodejs
        run: |
          npm pack

      - name: Upload package
        uses: actions/upload-artifact@v3
        with:
          name: package-${{ matrix.platform }}-${{ matrix.arch }}
          path: bindings/nodejs/pyjamaz-*.tgz

  publish:
    name: Publish to npm
    needs: build_packages
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && github.event.inputs.skip_publish != 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all packages
        uses: actions/download-artifact@v3
        with:
          path: packages/

      - name: Display structure
        run: ls -R packages/

      - name: Publish to npm
        working-directory: bindings/nodejs
        run: |
          # For now, just display what would be published
          # Actual publishing requires proper npm token and package naming strategy
          echo "Would publish packages:"
          ls -lh ../../packages/*/pyjamaz-*.tgz
          echo ""
          echo "NOTE: Multi-platform npm packages require either:"
          echo "  1. Platform-specific packages (@pyjamaz/darwin-x64, etc.) + main wrapper"
          echo "  2. Single package with platform detection at install time"
          echo ""
          echo "Current implementation: Single package with bundled binaries"
          echo "Users on different platforms need platform-specific tarballs"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  test_installation:
    name: Test installation on ${{ matrix.os }}
    needs: build_packages
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-14, ubuntu-22.04]

    steps:
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download package
        uses: actions/download-artifact@v3
        with:
          name: package-${{ matrix.os == 'macos-13' && 'darwin-x64' || matrix.os == 'macos-14' && 'darwin-arm64' || 'linux-x64' }}
          path: .

      - name: Install package
        run: |
          npm install ./pyjamaz-*.tgz

      - name: Test basic functionality
        run: |
          node -e "
            const { version, optimize } = require('pyjamaz');
            console.log('Pyjamaz version:', version());
            console.log('✓ Package installed and loaded successfully');
          "

      - name: Verify no brew dependencies needed
        run: |
          # This test verifies the package works without brew
          # On a fresh system, this would fail if dependencies weren't bundled
          echo "✓ Installation test passed"
